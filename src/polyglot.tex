%%% Copyright 2021 Ian Jackson and contributors
%%% SPDX-License-Identifier: MIT
%%% There is NO WARRANTY.

\documentclass[a4paper]{memoir}

\usepackage[british]{babel}
\usepackage[T1]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage{textcomp}
\usepackage{pslatex}
\usepackage{palatino}

\usepackage{color}

\makeatletter

\definecolor{darkgreen}{rgb}{0.0, 0.5, 0.0}
\definecolor{darkblue}{rgb}{0.0, 0.0, 0.6}

\errorcontextlines=\maxdimen

\usepackage
  [bookmarks = true, bookmarksnumbered = true, bookmarksdepth = 3,
   colorlinks = true, linkcolor = darkgreen, citecolor = darkgreen,
   urlcolor = darkblue, breaklinks = true]
  {hyperref}

\isopage[10]
\fixthelayout

\makechapterstyle{sans}
  {\renewcommand{\chapnamefont}{\normalfont\huge\sffamily\bfseries}
   \renewcommand{\chapnumfont}{\normalfont\huge\sffamily\bfseries}
   \renewcommand{\chaptitlefont}{\normalfont\Huge\sffamily\bfseries}}
\chapterstyle{sans}
\setsecheadstyle{\Large\sffamily\bfseries}
\setsubsecheadstyle{\large\sffamily\bfseries}
\setsubsubsecheadstyle{\sffamily\bfseries}
\setparaheadstyle{\sffamily\bfseries}
\setsubparaheadstyle{\sffamily\bfseries}
\setaftersubsecskip{-1em}
\maxsecnumdepth{subsection}

\nonzeroparskip \setnzplist
\setlength{\parindent}{0pt}

\hyphenpenalty=1000 \sloppy \raggedbottom

\makeoddfoot{plain}{}{}{}
\makeoddfoot{plain}{}{}{\thepage}
\makeevenhead{plain}{}{}{}
\makeevenfoot{plain}{\thepage}{}{}
\aliaspagestyle{contents}{plain}

\makeoddhead{headings}{}{}{\if@mainmatter\bfseries\rightmark\fi}
\makeoddfoot{headings}{}{}{\thepage}
\makeevenhead{headings}{\if@mainmatter\bfseries\leftmark\fi}{}{}
\makeevenfoot{headings}{\thepage}{}{}
\makepsmarks{headings}{%
  \renewcommand*{\chaptermark}[1]{\markboth{\@chapapp\ \thechapter. \ ##1}{}}%
  \renewcommand*{\sectionmark}[1]{\markright{\thesection. \ ##1}}%
}
\pagestyle{headings}

\newenvironment{longtable}[2][]
  {\begin{center}%
   \let\endhead=\relax
   \begin{tabular}{#2}}
  {\end{tabular}\end{center}}

\title{DRAFT -- Rust for the Polyglot Programmer}
\author{Ian Jackson and contributors}

%% Some hacking.  The objective here is to allow hyphenation of
%% `\texttt{...}' material after `::' separators.  First of all, keep the old
%% `\texttt' command around, because we'll need it.
\let\@latex@texttt=\texttt

%% If we're not actually typesetting stuff directly (e.g., writing to the
%% table-of-contents file, setting a page marker, or building a PDF bookmark
%% name) then just expand to `\texttt'.  Otherwise, it's fair game.
\def\texttt{\ifx\protect\@typeset@protect \expandafter\@texttt@i
  \else \expandafter\@latex@texttt \fi}

%% All we do is set stuff in monospace, with additional discretionary
%% hyphens.
\def\@texttt@i#1{\@latex@texttt{\addhyph@{#1}}}

%% And here's how we insert the discretionaries.  `\addhyph@i{SEP}{TEXT}'
%% inserts a discretionary hyphen after every SEP appearing at top-level in
%% TEXT.  (It doesn't peer into `{...}' groups.  Fortunately, we don't need
%% it to.)
\def\addhyph@#1{\addhyph@i{::}{#1}}
\def\addhyph@i#1#2{%
  %% Below, we'll call `\addhyph@ii TEXT SEP \q@end', so there's a known
  %% separator before the end marker `\q@end'.  This lets us use TeX's macro
  %% machinery to split TEXT into two pieces at the first occurrence of SEP.
  %% If the second piece is empty, we know we've found our sentinel, and
  %% should stop.  Otherwise, typeset the first piece, the separator, and a
  %% discretionary hyphen (/not/ in monospace), and process the second piece
  %% tail-recursively.
  \def\addhyph@ii##1#1##2\q@end{%
    ##1%
    \def\temp@{##2}%
    \ifx\temp@\empty\else #1\textrm{\-}\def\next@{\addhyph@ii##2\q@end}%
    \expandafter\next@\fi%
  }%
  %% Call `\addhyph@ii' as just defined to split our TEXT.  Insert `\relax'
  %% just before the sentinel separator: otherwise, we get confused if the
  %% separator consists of two similar characters, and the real TEXT ends
  %% with just one of them.
  \addhyph@ii#2\relax#1\q@end%
}

\begin{document}

\frontmatter

\begin{titlingpage}
  \maketitle
  \vfill
  \input{precontents}
\end{titlingpage}

\tableofcontents

\cleardoublepage
\mainmatter
\include{intro}
\include{syntax}
\include{types}
\include{ownership}
\include{traits}
\include{safety}
\include{errors}
\include{macros}
\include{async}
\include{ffi}
\include{rustdoc}
\include{stability}
\include{cargo}
\include{libs}

\backmatter
\include{colophon}

\end{document}
