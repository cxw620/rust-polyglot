#!/bin/sh
set -e

dirty=$(git status --porcelain)
if [ "x$dirty" != x ]; then
	git --no-pager status
	echo >&2 '** tree is dirty **'
#	exit 16
fi

if [ "x$(git symbolic-ref HEAD 2>/dev/null)" != xrefs/heads/main ]; then
	echo >&2 '** not on main branch **'
	exit 16
fi

git push --dry-run --quiet origin HEAD:published

make clean
make html pdf
set -x

rsync -r --delete ../Build/polyglot/html/. polyglot.pdf \
	ianmdlvl@chiark:public-html/rust-polyglot/.

push=HEAD:published

git fetch origin
if git merge-base --is-ancestor refs/remotes/origin/main HEAD
then
	push="$push HEAD:main"
fi

git push origin $push
